<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thailand Student Density Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f1f5f9;
        }

        #map {
            height: 700px;
            width: 100%;
            background: #ffffff;
            border-radius: 1.5rem;
            z-index: 10;
        }

        .leaflet-container {
            background-color: #f8fafc !important;
        }

        .custom-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            padding: 12px;
            font-size: 14px;
        }

        .map-legend {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sticky-table-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: white;
        }

        .highlight-row {
            background-color: #eff6ff !important;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="pb-12">

    <div class="max-w-7xl mx-auto px-4 pt-8">
        <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Thailand Student Density Heatmap</h1>
                <p class="text-slate-500 mt-1">การวิเคราะห์ความหนาแน่นเชิงพื้นที่ของนักเรียนใน 77 จังหวัด</p>
            </div>
            <div class="flex gap-2 text-sm font-medium">
                <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200">
                    <span class="text-blue-600">จำนวนนักเรียนทั้งหมด:</span> <span id="total-students-count">...</span>
                </div>
            </div>
        </div>

        <div class="relative bg-white p-2 rounded-[2rem] shadow-xl border border-slate-200 overflow-hidden">
            <div id="map"></div>
            
            <div class="absolute bottom-8 right-8 z-[1000] map-legend p-4 rounded-2xl shadow-lg border border-slate-100 hidden md:block">
                <p class="text-xs font-bold text-slate-700 uppercase tracking-widest mb-3">Student Density (per km²)</p>
                <div class="space-y-2">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #08306b"></div>
                        <span class="text-xs text-slate-600 font-medium">> 150 (Very High)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #08519c"></div>
                        <span class="text-xs text-slate-600 font-medium">100 - 150 (High)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #2171b5"></div>
                        <span class="text-xs text-slate-600 font-medium">50 - 100 (Medium High)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #4292c6"></div>
                        <span class="text-xs text-slate-600 font-medium">25 - 50 (Moderate)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #6baed6"></div>
                        <span class="text-xs text-slate-600 font-medium">15 - 25 (Low)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #9ecae1"></div>
                        <span class="text-xs text-slate-600 font-medium">10 - 15 (Very Low)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-sm" style="background: #deebf7"></div>
                        <span class="text-xs text-slate-600 font-medium">< 10 (Sparse)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 mt-12">
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h2 class="text-xl font-bold text-slate-800">ตารางข้อมูลความหนาแน่นรายจังหวัด</h2>
                <div class="relative max-w-sm w-full">
                    <input type="text" id="tableSearch" placeholder="ค้นหาจังหวัด..." 
                           class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    <svg class="w-5 h-5 absolute left-3 top-2.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky-table-header shadow-sm">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">จังหวัด</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">จำนวนนักเรียน</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">พื้นที่ (ตร.กม.)</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">ความหนาแน่น</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">ระดับความร้อน</th>
                        </tr>
                    </thead>
                    <tbody id="provinceTableBody" class="divide-y divide-slate-100">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const csvData = `ProvinceName,พื้นที่ (ตร.กม.),StudentCount,Students/sq.km
กระบี่,4708.51,107984,22.93379434
กรุงเทพมหานคร,1568.74,999183,636.9334625
กาญจนบุรี,19483.15,161836,8.306459684
กาฬสินธุ์,6946.75,181215,26.08629935
กำแพงเพชร,8607.49,119329,13.86339107
ขอนแก่น,10885.99,341217,31.3445998
จันทบุรี,6338,96097,15.1620385
ฉะเชิงเทรา,5351,134945,25.21865072
ชลบุรี,4611.83,360669,78.20518102
ชัยนาท,2469.75,49629,20.09474643
ชัยภูมิ,12778.3,186989,14.63332306
ชุมพร,6010.85,86012,14.30945708
เชียงราย,11678.37,218084,18.67418131
เชียงใหม่,20107.06,323075,16.06773934
ตรัง,4917.52,118471,24.09161325
ตราด,2819,38011,13.48385952
ตาก,16406.65,119853,7.305147608
นครนายก,2122,46722,22.01790763
นครปฐม,2168.33,181240,83.58506311
นครพนม,5512.67,118124,21.42772879
นครราชสีมา,20493.96,441999,21.56728129
นครศรีธรรมราช,9942.5,310183,31.1976867
นครสวรรค์,9597.68,172935,18.01841695
นนทบุรี,622.3,212759,341.8913707
นราธิวาส,4475.43,188201,42.05204863
น่าน,11472.13,83226,7.254624911
บึงกาฬ,4305,79822,18.5416957
บุรีรัมย์,10322.89,271243,26.27587855
ปทุมธานี,1525.86,236237,154.8221986
ประจวบคีรีขันธ์,6367.62,88730,13.93456268
ปราจีนบุรี,4762.36,92911,19.5094449
ปัตตานี,1940.36,171434,88.35164609
พระนครศรีอยุธยา,2556.64,153597,60.07767929
พะเยา,6335.06,73909,11.66666191
พังงา,4170.9,43851,10.51355823
พัทลุง,3424.47,94986,27.73742185
พิจิตร,4531.01,84755,18.70554247
พิษณุโลก,10815.85,148785,13.75619577
เพชรบุรี,6225.14,84547,13.58154194
เพชรบูรณ์,12668.42,170425,13.45274313
แพร่,6538.6,73902,11.30241948
ภูเก็ต,543.03,79234,145.9109073
มหาสารคาม,5291.68,159355,30.11425483
มุกดาหาร,4339.83,67741,15.60913676
แม่ฮ่องสอน,12681.26,56341,4.442855048
ยโสธร,4161.66,100473,24.14252966
ยะลา,4521.08,144551,31.97267025
ร้อยเอ็ด,8299.45,220241,26.5368187
ระนอง,3298.05,37777,11.45434423
ระยอง,3552,164943,46.43665541
ราชบุรี,5196.46,158979,30.59371187
ลพบุรี,6199.75,123498,19.91983548
ลำปาง,12533.96,112103,8.943941101
ลำพูน,4505.88,62983,13.97795769
เลย,11424.61,114886,10.05597951
ศรีสะเกษ,8840,248744,28.13846154
สกลนคร,9605.76,215682,22.4533965
สงขลา,7393.89,301416,40.76557807
สตูล,2478.98,64222,25.90662289
สมุทรปราการ,1004.09,240398,239.4187772
สมุทรสงคราม,416.71,28143,67.53617144
สมุทรสาคร,872.35,108719,124.6277297
สระแก้ว,7195.44,113429,15.76401165
สระบุรี,3576.49,116630,32.61018485
สิงห์บุรี,822.48,34861,42.38522517
สุโขทัย,6596.09,95663,14.50298586
สุพรรณบุรี,5358.01,139945,26.11883889
สุราษฎร์ธานี,12891.47,192135,14.90404112
สุรินทร์,8124.06,243224,29.93872509
หนองคาย,3027.28,83794,27.6796332
หนองบัวลำภู,3859.09,92697,24.02043487
อ่างทอง,968.37,42220,43.59903756
อำนาจเจริญ,3161.25,66974,21.18592329
อุดรธานี,11730.3,272100,23.19633769
อุตรดิตถ์,7838.59,71583,9.132126822
อุทัยธานี,6730.25,55005,8.172801813
อุบลราชธานี,15744.8,337325,21.42453381`;

        const engToThai = {
            "Bangkok": "กรุงเทพมหานคร", "Krung Thep Maha Nakhon": "กรุงเทพมหานคร", "Phra Nakhon": "กรุงเทพมหานคร", "Bangkok Metropolis": "กรุงเทพมหานคร",
            "Samut Prakan": "สมุทรปราการ", "Nonthaburi": "นนทบุรี", "Pathum Thani": "ปทุมธานี",
            "Phra Nakhon Si Ayutthaya": "พระนครศรีอยุธยา", "Ayutthaya": "พระนครศรีอยุธยา", "Ang Thong": "อ่างทอง", 
            "Lop Buri": "ลพบุรี", "Lopburi": "ลพบุรี", "Loburi": "ลพบุรี", "Sing Buri": "สิงห์บุรี",
            "Chai Nat": "ชัยนาท", "Saraburi": "สระบุรี", "Chon Buri": "ชลบุรี", "Chonburi": "ชลบุรี", "Rayong": "ระยอง", 
            "Chanthaburi": "จันทบุรี", "Trat": "ตราด", "Chachoengsao": "ฉะเชิงเทรา", 
            "Prachin Buri": "ปราจีนบุรี", "Prachinburi": "ปราจีนบุรี", "Nakhon Nayok": "นครนายก",
            "Sa Kaeo": "สระแก้ว", "Nakhon Ratchasima": "นครราชสีมา", "Korat": "นครราชสีมา",
            "Buri Ram": "บุรีรัมย์", "Buriram": "บุรีรัมย์", "Surin": "สุรินทร์",
            "Si Sa Ket": "ศรีสะเกษ", "Sisaket": "ศรีสะเกษ", "Ubon Ratchathani": "อุบลราชธานี", "Yasothon": "ยโสธร", 
            "Chaiyaphum": "ชัยภูมิ", "Amnat Charoen": "อำนาจเจริญ", 
            "Nong Bua Lam Phu": "หนองบัวลำภู", "Nong Bua Lamphu": "หนองบัวลำภู",
            "Khon Kaen": "ขอนแก่น", "Udon Thani": "อุดรธานี", "Loei": "เลย", 
            "Nong Khai": "หนองคาย", "Maha Sarakham": "มหาสารคาม", "Roi Et": "ร้อยเอ็ด", "Kalasin": "กาฬสินธุ์",
            "Sakon Nakhon": "สกลนคร", "Nakhon Phanom": "นครพนม", "Mukdahan": "มุกดาหาร", "Chiang Mai": "เชียงใหม่",
            "Lamphun": "ลำพูน", "Lampang": "ลำปาง", "Uttaradit": "อุตรดิตถ์", "Phrae": "แพร่", "Nan": "น่าน",
            "Phayao": "พะเยา", "Chiang Rai": "เชียงราย", "Mae Hong Son": "แม่ฮ่องสอน", "Nakhon Sawan": "นครสวรรค์",
            "Uthai Thani": "อุทัยธานี", "Kamphaeng Phet": "กำแพงเพชร", "Tak": "ตาก", "Sukhothai": "สุโขทัย",
            "Phitsanulok": "พิษณุโลก", "Phichit": "พิจิตร", "Phetchabun": "เพชรบูรณ์", "Ratchaburi": "ราชบุรี",
            "Kanchanaburi": "กาญจนบุรี", "Suphan Buri": "สุพรรณบุรี", "Suphanburi": "สุพรรณบุรี", "Nakhon Pathom": "นครปฐม", 
            "Samut Sakhon": "สมุทรสาคร", "Samut Songkhram": "สมุทรสงคราม", "Phetchaburi": "เพชรบุรี", 
            "Prachuap Khiri Khan": "ประจวบคีรีขันธ์", "Nakhon Si Thammarat": "นครศรีธรรมราช", "Krabi": "กระบี่", 
            "Phang-nga": "พังงา", "Phangnga": "พังงา", "Phuket": "ภูเก็ต",
            "Surat Thani": "สุราษฎร์ธานี", "Ranong": "ระนอง", "Chumphon": "ชุมพร", "Songkhla": "สงขลา", "Satun": "สตูล",
            "Trang": "ตรัง", "Phatthalung": "พัทลุง", "Pattani": "ปัตตานี", "Yala": "ยะลา", "Narathiwat": "นราธิวาส",
            "Bueng Kan": "บึงกาฬ"
        };

        const provincesData = [];
        const rows = csvData.trim().split('\n').slice(1);
        let grandTotalStudents = 0;

        rows.forEach(row => {
            const cols = row.split(',');
            if (cols.length < 4) return;
            const name = cols[0].trim();
            const area = parseFloat(cols[1]);
            const count = parseInt(cols[2]);
            const density = parseFloat(cols[3]);
            
            if (!isNaN(area) && !isNaN(count)) {
                provincesData.push({
                    name,
                    area,
                    count,
                    density: isNaN(density) ? 0 : density
                });
                grandTotalStudents += count;
            }
        });

        const studentCountEl = document.getElementById('total-students-count');
        if (studentCountEl) studentCountEl.innerText = grandTotalStudents.toLocaleString();

        const map = L.map('map', {
            zoomSnap: 0.1,
            center: [13.7367, 100.5231],
            zoom: 6,
            trackResize: true
        });

        function getColor(d) {
            return d > 150 ? '#08306b' :
                   d > 100 ? '#08519c' :
                   d > 50  ? '#2171b5' :
                   d > 25  ? '#4292c6' :
                   d > 15  ? '#6baed6' :
                   d > 10  ? '#9ecae1' :
                             '#deebf7';
        }

        function findProvinceData(feature) {
            const props = feature.properties || {};
            const namesToTry = [
                props.name, props.NAME_1, props.NAME_ASCI, props.PROVINCE_E, props.NAME_ENG, props.NAME_0, props.NAME_2
            ].filter(n => !!n);

            for (let engName of namesToTry) {
                const cleanEngName = engName.replace('Changwat ', '').trim();
                const thaiMappedName = engToThai[cleanEngName] || cleanEngName;
                
                // Direct match or Fuzzy match
                const found = provincesData.find(p => 
                    p.name === thaiMappedName || 
                    p.name === cleanEngName || 
                    p.name.includes(thaiMappedName) || 
                    thaiMappedName.includes(p.name)
                );
                if (found) return found;
            }
            return null;
        }

        function style(feature) {
            const pData = findProvinceData(feature);
            return {
                fillColor: getColor(pData ? pData.density : 0),
                weight: 1,
                opacity: 1,
                color: '#ffffff',
                fillOpacity: 0.9
            };
        }

        let geoJsonLayer;

        function onEachFeature(feature, layer) {
            const pData = findProvinceData(feature);

            layer.on({
                mouseover: (e) => {
                    const l = e.target;
                    l.setStyle({ weight: 2.5, color: '#2563eb', fillOpacity: 1 });
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        l.bringToFront();
                    }
                },
                mouseout: (e) => {
                    if (geoJsonLayer) geoJsonLayer.resetStyle(e.target);
                },
                click: (e) => {
                    if (pData) {
                        scrollToProvince(pData.name);
                        safeFitBounds(e.target.getBounds());
                    }
                }
            });

            if (pData) {
                layer.bindTooltip(`
                    <div class="custom-tooltip">
                        <strong class="text-blue-800 text-lg">${pData.name}</strong><br/>
                        <span class="text-slate-500">ความหนาแน่น:</span> <strong>${pData.density.toFixed(2)}</strong> /ตร.กม.<br/>
                        <span class="text-slate-500">นักเรียน:</span> <strong>${pData.count.toLocaleString()} คน</strong>
                    </div>
                `, { sticky: true, className: 'custom-tooltip-wrapper' });
            }
        }

        function safeFitBounds(bounds, options = {}) {
            if (!bounds || typeof bounds.isValid !== 'function' || !bounds.isValid()) return;
            const center = bounds.getCenter();
            if (isNaN(center.lat) || isNaN(center.lng)) return;
            try {
                map.fitBounds(bounds, { animate: true, ...options });
            } catch (e) {}
        }

        fetch('https://raw.githubusercontent.com/apisit/thailand.json/master/thailand.json')
            .then(res => res.json())
            .then(data => {
                if (data && data.features) {
                    data.features = data.features.filter(f => f.geometry && f.geometry.coordinates);
                }

                geoJsonLayer = L.geoJson(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                requestAnimationFrame(() => {
                    const bounds = geoJsonLayer.getBounds();
                    if (bounds && bounds.isValid()) {
                        map.invalidateSize({ animate: false });
                        setTimeout(() => {
                            safeFitBounds(bounds, { padding: [20, 20], animate: false });
                        }, 50);
                    }
                });
            })
            .catch(err => {
                map.setView([13.7367, 100.5231], 6);
            });

        const tableBody = document.getElementById('provinceTableBody');
        const searchInput = document.getElementById('tableSearch');

        function renderTable(data) {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const sortedData = [...data].sort((a, b) => b.density - a.density);
            
            sortedData.forEach(p => {
                const row = document.createElement('tr');
                row.id = `row-${p.name}`;
                row.className = 'hover:bg-slate-50 transition-colors cursor-pointer';
                row.innerHTML = `
                    <td class="px-6 py-4 font-semibold text-slate-800">${p.name}</td>
                    <td class="px-6 py-4 text-slate-600">${p.count.toLocaleString()}</td>
                    <td class="px-6 py-4 text-slate-600">${p.area.toLocaleString()}</td>
                    <td class="px-6 py-4 font-bold text-blue-700">${p.density.toFixed(2)}</td>
                    <td class="px-6 py-4">
                        <div class="w-full bg-slate-100 rounded-full h-2">
                            <div class="h-2 rounded-full" style="width: ${Math.min(100, (p.density / 200) * 100)}%; background: ${getColor(p.density)}"></div>
                        </div>
                    </td>
                `;
                row.onclick = () => {
                    highlightOnMap(p.name);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                tableBody.appendChild(row);
            });
        }

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const filtered = provincesData.filter(p => p.name.toLowerCase().includes(val));
                renderTable(filtered);
            });
        }

        function scrollToProvince(name) {
            const el = document.getElementById(`row-${name}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('highlight-row');
                setTimeout(() => el.classList.remove('highlight-row'), 2000);
            }
        }

        function highlightOnMap(name) {
            if (!geoJsonLayer) return;
            geoJsonLayer.eachLayer(layer => {
                const props = layer.feature.properties || {};
                const pName = (props.name || props.NAME_1 || "").replace('Changwat ', '').trim();
                const thaiMappedName = engToThai[pName] || pName;

                if (thaiMappedName === name || name.includes(thaiMappedName)) {
                    layer.setStyle({ weight: 4, color: '#fbbf24' });
                    safeFitBounds(layer.getBounds());
                    setTimeout(() => {
                        if (geoJsonLayer) geoJsonLayer.resetStyle(layer);
                    }, 3000);
                }
            });
        }

        renderTable(provincesData);
    </script>
</body>
</html>
